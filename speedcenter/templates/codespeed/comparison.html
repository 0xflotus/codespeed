{% extends "base.html" %}
{% block title %}: Comparison{% endblock %}
{% block script %}
<!--[if IE]><script language="javascript" type="text/javascript" src="/media/js/jqplot/excanvas.min.js"></script><![endif]-->
<link rel="stylesheet" type="text/css" href="../media/js/jqplot/jquery.jqplot.min.css" />
<script type="text/javascript" src="../media/js/jqplot/jquery.jqplot.min.js"></script>
<script type="text/javascript" src="../media/js/jqplot/jqplot.barRenderer.min.js"></script>
<script type="text/javascript" src="../media/js/jqplot/jqplot.categoryAxisRenderer.min.js"></script>
<script type="text/javascript" src="../media/js/jqplot/jqplot.canvasTextRenderer.min.js"></script>
<script type="text/javascript" src="../media/js/jqplot/jqplot.canvasAxisTickRenderer.min.js"></script>
<script type="text/javascript" src="../media/js/jqplot/jqplot.canvasAxisLabelRenderer.min.js"></script>

<script type="text/javascript">
  var compdata = new Object();
  var bench_units = eval({{ bench_units|safe }});
  
  var plotheight = 10;  
  function getConfiguration() {
    var config = new Object();
    config["exe"] = readCheckbox("input[name='executables']:checked");
    config["ben"] = readCheckbox("input[name='benchmarks']:checked");
    config["env"] = readCheckbox("input[name='environments']:checked");
    config["chart"] = $("#chart_type option:selected").val();
    return config;
  }      

  function refreshContent() {
    var conf = getConfiguration();
    var exes = conf['exe'].split(",");
    var bens  = conf['ben'].split(",");
    var enviros = conf['env'].split(",");
    
    h = parseInt($("#plotwrapper").css("height"));//get height for error message
    if (exes[0] == "") {
      $("#plotwrapper").html(getLoadText("No executables selected", h, false));
      return false;
    } else if (bens[0] == "") {
      $("#plotwrapper").html(getLoadText("No benchmarks selected", h, false));
      return false;
    } else if (enviros[0] == "") {
      $("#plotwrapper").html(getLoadText("No environments selected", h, false));
      return false;
    }
    
    $("#plotwrapper").fadeOut("fast", function() {
      $(this).html("").show();
      var plotcounter = 1;
      for (unit in bench_units) {
        var benchmarks = new Array();
        for (ben in bens) {
          if ($.inArray(parseInt(bens[ben]), bench_units[unit][0]) != -1) {
            benchmarks.push(bens[ben]);
          }
        }
        if (benchmarks.length == 0) { continue; }
        var axislabel = unit + bench_units[unit][1];
        var plotid = "plot" + plotcounter;
        plotcounter++;
        $("#plotwrapper").append('<div id="' + plotid + '" class="compplot"></div>');
        
        var plotdata = [];
        var ticks = new Array();
        for (var b in benchmarks) {
          ticks.push($("label[for='benchmark_" + benchmarks[b] + "']").text());
        }
        var series = [];
        var barcounter = 0;
        for (var i in exes) {
          for (var j in enviros) {
            var exe = $("label[for='exe_" + exes[i] + "']").text();
            var env = $("label[for='env_" + enviros[j] + "']").text();
            series.push({'label': exe + " @ " + env});
            var customdata = [];
            var benchcounter = 0;
            for (var b in benchmarks) {
              benchcounter++;
              barcounter++;
              if (conf['chart'].indexOf("horizontal") == -1) {
                customdata.push(compdata[exes[i]][enviros[j]][benchmarks[b]]);
              } else {
                customdata.push([compdata[exes[i]][enviros[j]][benchmarks[b]], benchcounter]);
              }
            }
            plotdata.push(customdata);
          }
        }
    
    var plotoptions = new Object();
    if (conf['chart'].indexOf("horizontal") == -1) {
      plotoptions = {
        seriesDefaults: {
          renderer:$.jqplot.BarRenderer,
          rendererOptions:{barDirection: "vertical", barPadding: 6, barMargin: 15}
        },
        axesDefaults: {
          tickRenderer: $.jqplot.CanvasAxisTickRenderer
        },
        axes: {
          xaxis:{
            renderer:$.jqplot.CategoryAxisRenderer,
            ticks: ticks,
            tickOptions: {angle: 0}
          },
          yaxis:{min:0, label: axislabel, labelRenderer: $.jqplot.CanvasAxisLabelRenderer}
        }
      }
    } else {
      plotoptions = {
        seriesDefaults: {
          renderer:$.jqplot.BarRenderer,
          rendererOptions:{barDirection: "horizontal", barPadding: 8, barMargin: 15}
        },
        axesDefaults: {
          tickRenderer: $.jqplot.CanvasAxisTickRenderer,
          tickOptions: {angle: 0}
        },
        axes: {
          xaxis:{min:0}, 
          yaxis:{
            renderer:$.jqplot.CategoryAxisRenderer,
            ticks: ticks
          }
        }
      }
    }
    
    plotoptions.legend = {show: true, location: 'ne'};
    plotoptions.series = series;
    
    // Determine plot width and height and its optimal style
    // Depends on screen width and number of bars being displayed
    var w = barcounter * (plotoptions.seriesDefaults.rendererOptions.barPadding*2 + 20) + benchcounter * plotoptions.seriesDefaults.rendererOptions.barMargin * 2;
    var h = plotheight;
    if (conf['chart'].indexOf("horizontal") == -1) {
      w += 60;
      var plotwidth = $("#plotwrapper").width();
      if (w > plotwidth + 180) {
        plotoptions.seriesDefaults.rendererOptions.barPadding = 4;
        plotoptions.seriesDefaults.rendererOptions.barMargin = 10;
        plotoptions.seriesDefaults.shadow = false;
      }
      if (w > plotwidth + 80) {
        plotoptions.axes.xaxis.tickOptions.angle = -30;
      }
      if (w > plotwidth) {
        w = plotwidth;
      } else if (w < 300) {
        w = 300;
        plotoptions.seriesDefaults.rendererOptions.barPadding = 14;
        plotoptions.seriesDefaults.rendererOptions.barMargin = 25;
      }
    } else {
      if (w > 820) {
        w = w/2;
        plotoptions.seriesDefaults.rendererOptions.barPadding = 4;
        plotoptions.seriesDefaults.rendererOptions.barMargin = 10;
        plotoptions.seriesDefaults.shadow = false;
      } else if (w < 300) {
        w = 300;
        plotoptions.seriesDefaults.rendererOptions.barPadding = 14;
        plotoptions.seriesDefaults.rendererOptions.barMargin = 25;
      }
      h = w;
      w = "100%";
    }
    
    // Render plot
      $("#" + plotid).css('width', w);
      $("#" + plotid).css('height', h);
      plot = $.jqplot(plotid, plotdata, plotoptions);
  }
  });
  
  }
  
  function savedata(data) {
    if (data['error'] != "None") {
      h = parseInt($("#content").css("height"));//get height for error message
      $("#cplot").html(getLoadText(data["error"], h, false));
      return 1;
    }
    delete data['error'];
    compdata = data;
    refreshContent();
  }
  
  $(function() {
    $.ajaxSetup ({  
      cache: false  
    });
    
    //set default chart type
    $("#chart_type").val("{{ selectedchart }}");
    $("#chart_type").change(refreshContent);
    //reset all checkboxes
    $("input:checkbox").removeAttr('checked');
    
    //set default selected executables
    {% for checkedexecutable in checkedexecutables %}
    $("input[name='executables']").filter('[value={{ checkedexecutable }}]').attr('checked', true);{% endfor %}
    $("input[name='executables']").change(refreshContent);
    
    //set default selected benchmarks
    {% for checkedbenchmark in checkedbenchmarks %}
    $("input:checkbox[name='benchmarks']").filter('[value={{ checkedbenchmark.id }}]').attr('checked', true);{% endfor %}
    $("input[name='benchmarks']").change(refreshContent);
    
    //set default selected environments
    {% for checkedenv in checkedenviros %}
    $("input:checkbox[name='environments']").filter('[value={{ checkedenv.id }}]').attr('checked', true);{% endfor %}
    $("input[name='environments']").change(refreshContent);
    
    // Check all and none links
    $('.checkall').click(function() {
      $(this).parent().children("li").children("input").each(function() {
        $(this).attr('checked', true);
      });
      refreshContent();
      return false;
    });
    
    $('.uncheckall').click(function() {
      $(this).parent().children("li").children("input").each(function() {
        $(this).attr('checked', false);
      });
      refreshContent();
      return false;
    });
    
    plotheight = $("#cplot").height();
    // Get comparison data
    var h = parseInt($("#content").css("height"));//get height for loading text
    $("#cplot").html(getLoadText("Loading...", h, true));
    $.getJSON("json/", savedata);
  });
</script>
{% endblock %}
{% block navigation %}
    <ul class="inline">
    
      <li><a href="/changes/">Changes</a></li>
      <li><a href="/timeline/">Timeline</a></li>
      <li class="current"><a href="/comparison/">Comparison</a></li>
    </ul>
{% endblock %}
{% block body %}
<div id="sidebar">
<div id="executable" class="sidebox">
  <div class="boxhead"><h2>Executables</h2></div>
  <div class="boxbody">
    <ul><a href="#" class="checkall">All</a>, <a href="#" class="uncheckall">None</a>
    {% for exe in executables %}
      <li title="{{ exe.executable }} {{ exe.revision }}">
        <input id="exe_{{ exe.key }}" type="checkbox" name="executables" value="{{ exe.key }}" />
        <label for="exe_{{ exe.key }}">{{ exe.name|truncatewords:2 }}</label><div class="seriescolor"></div>
      </li>{% endfor %}
    </ul>
  </div>
</div>
<div id="benchmark" class="sidebox">
  <div class="boxhead"><h2>Benchmarks</h2></div>
  <div class="boxbody">
  {% for key,benchlist in benchmarks.items %}
  <ul>{{ key }} (<a href="#" class="checkall">All</a>, <a href="#" class="uncheckall">None</a>)
    {% for bench in benchlist|dictsort:"name" %}
    <li title="{{ bench.description }}">
      <input id="benchmark_{{ bench.id }}" type="checkbox" name="benchmarks" value="{{ bench.id }}" />
      <label for="benchmark_{{ bench.id }}">{{ bench }}</label>
    </li>{% endfor %}
  </ul>{% endfor %}
  </div>
</div>
<div class="sidebox">
  <div class="boxhead"><h2>Environments</h2></div>
  <div class="boxbody">
    <ul>{% for env in enviros %}
      <li title="{{ env.os }}, {{ env.cpu }}">
        <input id="env_{{ env.id }}" type="checkbox" name="environments" value="{{ env.id }}" />
        <label for="env_{{ env.id }}">{{ env }}</label>
      </li>{% endfor %}
    </ul>
  </div>
</div>
</div>

<div id="configbar">Choose chart type:
  <select id="chart_type" title="">{% for chart in charts %}
    <option value="{{ chart }}">{{ chart }}</option>{% endfor %}
  </select><a id="permalink" href="javascript:permalink();">Permalink</a>
</div>
<div id="content" class="clearfix">
<div id="plotwrapper"></div>
</div>
{% endblock %}
